#!/usr/bin/env bash
#
# cc-continue - Resume the last Claude Code session
#
# Usage:
#   cc-continue             Resume most recent session
#   cc-continue -l          List recent sessions
#   cc-continue <session>   Resume specific session
#

set -e

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/../.env" ]]; then
    source "$SCRIPT_DIR/../.env"
fi

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_help() {
    echo "cc-continue - Resume Claude Code sessions"
    echo ""
    echo "Usage:"
    echo "  cc-continue             Resume most recent session"
    echo "  cc-continue -l          List recent sessions"
    echo "  cc-continue <session>   Resume specific session by ID"
    echo ""
    echo "Claude Code maintains conversation history automatically."
    echo "Use --continue to pick up where you left off."
}

list_sessions() {
    echo -e "${BLUE}Recent Claude Code sessions:${NC}"
    echo ""

    # Claude Code stores sessions in ~/.claude/
    local sessions_dir="$HOME/.claude/projects"

    if [[ -d "$sessions_dir" ]]; then
        # List recent projects with timestamps
        find "$sessions_dir" -maxdepth 2 -name "*.json" -type f -printf '%T@ %p\n' 2>/dev/null | \
            sort -rn | \
            head -10 | \
            while read -r timestamp path; do
                local name=$(basename "$(dirname "$path")")
                local date=$(date -d "@${timestamp%.*}" "+%Y-%m-%d %H:%M" 2>/dev/null || echo "unknown")
                echo "  $name  ($date)"
            done
    else
        echo -e "${YELLOW}No session history found${NC}"
    fi
}

# Parse arguments
case "${1:-}" in
    -h|--help)
        print_help
        ;;
    -l|--list)
        list_sessions
        ;;
    "")
        # Resume last session
        echo -e "${BLUE}Resuming Claude Code session...${NC}"
        echo ""
        exec claude --continue
        ;;
    *)
        # Resume specific session (if Claude supports it)
        echo -e "${BLUE}Resuming session:${NC} $1"
        echo ""
        exec claude --continue --resume "$1"
        ;;
esac
