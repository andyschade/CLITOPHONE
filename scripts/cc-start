#!/usr/bin/env bash
# cc-start - Start a new Claude Code session in TMUX
# Usage: cc-start [session-name] [directory]

set -euo pipefail

# Configuration
MACHINE_EMOJI="${CLITOPHONE_EMOJI:-ðŸ–¥ï¸}"  # Machine identifier emoji
DEFAULT_SESSION="claude"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

show_usage() {
    cat << EOF
Usage: cc-start [session-name] [directory]

Start a new Claude Code session in TMUX.

Arguments:
  session-name    Name for the TMUX session (default: claude)
  directory       Working directory (default: current directory)

Examples:
  cc-start                    # Start session named 'claude' in current dir
  cc-start myproject          # Start session named 'myproject'
  cc-start myproject ~/code   # Start in ~/code directory

Environment Variables:
  CLITOPHONE_EMOJI    Machine identifier emoji (default: ðŸ–¥ï¸)

EOF
}

check_dependencies() {
    local missing=()

    if ! command -v tmux &> /dev/null; then
        missing+=("tmux")
    fi

    if ! command -v claude &> /dev/null; then
        missing+=("claude (Claude Code)")
    fi

    if [ ${#missing[@]} -gt 0 ]; then
        log_error "Missing dependencies: ${missing[*]}"
        log_error "Please run setup-env.sh first."
        exit 1
    fi
}

create_session() {
    local session_name="$1"
    local work_dir="$2"

    # Check if session already exists
    if tmux has-session -t "$session_name" 2>/dev/null; then
        log_warn "Session '$session_name' already exists."
        read -p "Attach to existing session? [Y/n] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Nn]$ ]]; then
            log_info "Use 'cc-start <new-name>' to create a different session."
            exit 0
        fi
        tmux attach-session -t "$session_name"
        exit 0
    fi

    # Create new session
    log_info "Creating new Claude Code session: ${MACHINE_EMOJI} $session_name"

    # Create detached session
    tmux new-session -d -s "$session_name" -c "$work_dir"

    # Set environment variables in the session
    tmux set-environment -t "$session_name" CLITOPHONE_SESSION "$session_name"

    # Send claude command to the session
    tmux send-keys -t "$session_name" "cd '$work_dir' && claude" Enter

    # Attach to the session
    log_success "Session created! Attaching..."
    tmux attach-session -t "$session_name"
}

# Main
main() {
    # Handle help flag
    if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
        show_usage
        exit 0
    fi

    # Check dependencies
    check_dependencies

    # Parse arguments
    local session_name="${1:-$DEFAULT_SESSION}"
    local work_dir="${2:-$(pwd)}"

    # Validate working directory
    if [ ! -d "$work_dir" ]; then
        log_error "Directory does not exist: $work_dir"
        exit 1
    fi

    # Resolve to absolute path
    work_dir=$(cd "$work_dir" && pwd)

    # Create and attach to session
    create_session "$session_name" "$work_dir"
}

main "$@"
